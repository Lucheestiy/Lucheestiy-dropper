services:
  app:
    build:
      context: ./app
    image: mri-cooling-droppr-app:custom
    container_name: droppr-app
    restart: unless-stopped
    user: "1000:1000"
    volumes:
      - ./data:/srv
      - ./database:/database
      - ./config:/config
    networks:
      - default
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:80/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  droppr:
    image: nginx:1.25-alpine
    container_name: droppr
    restart: unless-stopped
    ports:
      - "${DROPPR_HOST_PORT:-8098}:80"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/gallery.html:/usr/share/nginx/html/gallery.html:ro
      - ./nginx/analytics.html:/usr/share/nginx/html/analytics.html:ro
      - ./nginx/media-viewer.html:/usr/share/nginx/html/media-viewer.html:ro
      - ./nginx-fixed/video-player.html:/usr/share/nginx/html/video-player.html:ro
      - ./nginx/test-media.html:/usr/share/nginx/html/test-media.html:ro
      - ./nginx/stream-gallery.html:/usr/share/nginx/html/stream-gallery.html:ro
      - ./nginx/droppr-theme.css:/usr/share/nginx/html/droppr-theme.css:ro
      - ./nginx/droppr-panel.js:/usr/share/nginx/html/droppr-panel.js:ro
      - ./database/proxy-cache:/usr/share/nginx/html/proxy-cache:ro
    depends_on:
      app:
        condition: service_healthy
    networks:
      - default
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://127.0.0.1:80/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 5s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  media-server:
    build:
      context: ./media-server
    container_name: droppr-media-server
    restart: unless-stopped
    command: gunicorn --bind 0.0.0.0:5000 --workers 4 --threads 10 --access-logfile - --error-logfile - app:app
    user: "1000:1000"
    volumes:
      - ./database:/database
      - ./data:/srv
    environment:
      - DROPPR_CACHE_DIR=/database/thumb-cache
      - DROPPR_THUMB_MAX_CONCURRENCY=1
      - DROPPR_PROXY_CACHE_DIR=/database/proxy-cache
      - DROPPR_PROXY_MAX_CONCURRENCY=1
    depends_on:
      app:
        condition: service_healthy
    networks:
      - default
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:5000/health', timeout=5)"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    logging:
      driver: "json-file"
      options:
        max-size: "20m"
        max-file: "5"


networks:
  default:
    name: mri-cooling-droppr_default
